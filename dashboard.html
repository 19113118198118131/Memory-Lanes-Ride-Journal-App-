<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>My Ride Journal</h1>
    <button id="logout-btn">Logout</button>
  </header>

  <main>
    <h2>Your Rides</h2>
    <div id="ride-list">Loading rides‚Ä¶</div>
  </main>

  <!-- Inline module to handle auth, fetch, render & click logic -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ‚Äî Initialize Supabase ‚Äî
    const SUPABASE_URL     = 'https://vodujxiwkpxaxaqnwkdd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvZHVqeGl3a3B4YXhhcW53a2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTgwOTQsImV4cCI6MjA2MjMzNDA5NH0.k4NeZ3dgqe1QQeXmkmgThp-X_PwOHPHLAQErg3hrPok';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase;

    console.log('‚ö° dashboard.html module loaded');

    // DOM refs
    const rideList  = document.getElementById('ride-list');
    const logoutBtn = document.getElementById('logout-btn');

    // ‚Äî 1) Auth check ‚Äî
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      console.warn('Not logged in, redirecting‚Ä¶');
      return window.location.href = 'index.html';
    }
    console.log('Logged in as:', user.email);

    // ‚Äî 2) Fetch rides ‚Äî
    const { data: rides, error: fetchError } = await supabase
      .from('ride_logs')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });

    rideList.innerHTML = '';

    if (fetchError) {
      console.error('Error fetching rides:', fetchError);
      rideList.textContent = '‚ùå Failed to load rides.';
    } else if (!rides.length) {
      rideList.textContent = 'No rides found.';
    } else {
      rides.forEach(ride => {
        const item = document.createElement('div');
        item.className = 'ride-entry';
        item.innerHTML = `
          <div class="ride-title">${ride.title}</div>
          <div class="ride-details">
            <span>üìç ${ride.distance_km.toFixed(1)} km</span>
            <span>‚è± ${ride.duration_min} min</span>
            <span>‚õ∞Ô∏è ${ride.elevation_m} m</span>
          </div>
        `;

        // ‚Üê **Click handler**: queue ride and go back to index.html
        item.addEventListener('click', () => {
          console.log('‚Üí ride clicked:', ride.id);
          localStorage.setItem('selectedRideId', ride.id);
          window.location.href = 'index.html';
        });

        rideList.appendChild(item);
      });
    }

    // ‚Äî 3) Logout logic ‚Äî
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      console.log('Signed out');
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
