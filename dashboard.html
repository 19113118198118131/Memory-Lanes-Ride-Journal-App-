<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <div class="dashboard-header">
    <h1>My Ride Journal</h1>
    <div class="button-group">
      <button id="home-btn">â• New Ride</button>
      <button id="logout-btn">Logout</button>
    </div>
  </div>
</header>



  <main>
    <h2>Your Rides</h2>
    <div id="ride-list">Loading ridesâ€¦</div>
  </main>

  <script type="module">
    import supabase from './supabaseClient.js';

    (async () => {
      console.log('âš¡ dashboard module start');


      // â”€â”€ DOM refs â”€â”€
      const rideList  = document.getElementById('ride-list');
      const logoutBtn = document.getElementById('logout-btn');
      const homeBtn   = document.getElementById('home-btn');
  
      // Navigate back to upload page without signing out
      homeBtn.addEventListener('click', () => {
      // Navigate back to upload page without signing out, include home flag
        window.location.href = 'index.html?home=1';
      });
  
      // Logout and redirect to upload/login page
      logoutBtn.addEventListener('click', async () => {
        console.log('â†’ signing out');
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      });

      try {
        // 1ï¸âƒ£ Auth check
        console.log('â†’ checking auth');
        const { data: { user }, error: authErr } = await supabase.auth.getUser();
        if (authErr) throw authErr;
        if (!user) {
          console.warn('Ã— not logged in, redirecting');
          return window.location.href = 'index.html';
        }
        console.log('âœ” logged in as', user.email);

        // 2ï¸âƒ£ Fetch rides
        console.log('â†’ fetching rides');
        const { data: rides, error: fetchErr } = await supabase
          .from('ride_logs')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });
        if (fetchErr) throw fetchErr;

        rideList.innerHTML = '';
        if (!rides.length) {
          console.log('â€“ no rides found');
          rideList.textContent = 'No rides logged yet.';
        } else {
          console.log(`âœ” rendering ${rides.length} rides`);
          rides.forEach(ride => {
            const item = document.createElement('div');
            item.className = 'ride-entry';
            item.innerHTML = `
              <div class="ride-title">${ride.title}</div>
              <div class="ride-details">
                <span>ğŸ“ ${ride.distance_km.toFixed(1)} km</span>
                <span>â± ${ride.duration_min} min</span>
                <span>â›°ï¸ ${ride.elevation_m} m</span>
              </div>
              <button class="btn-delete" data-id="${ride.id}" data-path="${ride.gpx_path}">ğŸ—‘ï¸ Delete</button>
            `;

            // â† Your click handler is here!
        item.addEventListener('click', () => {
          console.log('â†’ ride clicked:', ride.id);
          // send the user to index.html?ride=<id>
          window.location.href = `index.html?ride=${ride.id}`;
        });



            rideList.appendChild(item);
          });
        }
      } catch (err) {
        console.error('âŒ dashboard error:', err);
        rideList.textContent = 'âš ï¸ Error loading rides. Check console.';
      }

      // 3ï¸âƒ£ Logout
      logoutBtn.addEventListener('click', async () => {
        console.log('â†’ signing out');
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      });

      console.log('âš¡ dashboard module end');
    })();
  </script>
</body>
</html>
