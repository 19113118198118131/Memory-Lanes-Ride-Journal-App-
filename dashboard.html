<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>My Ride Journal</h1>
   <button id="home-btn">New Ride</button>
   <button id="logout-btn">Logout</button>
  </header>


  <main>
    <h2>Your Rides</h2>
    <div id="ride-list">Loading rides‚Ä¶</div>
  </main>

  <script type="module">
    import supabase from './supabaseClient.js';

    (async () => {
      console.log('‚ö° dashboard module start');

      // ‚îÄ‚îÄ Supabase setup ‚îÄ‚îÄ
      const SUPABASE_URL      = 'https://vodujxiwkpxaxaqnwkdd.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvZHVqeGl3a3B4YXhhcW53a2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTgwOTQsImV4cCI6MjA2MjMzNDA5NH0.k4NeZ3dgqe1QQeXmkmgThp-X_PwOHPHLAQErg3hrPok';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
      // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
      const rideList  = document.getElementById('ride-list');
      const logoutBtn = document.getElementById('logout-btn');
      const homeBtn   = document.getElementById('home-btn');
  
      // Navigate back to upload page without signing out
      homeBtn.addEventListener('click', () => {
      // Navigate back to upload page without signing out, include home flag
        window.location.href = 'index.html?home=1';
      });
  
      // Logout and redirect to upload/login page
      logoutBtn.addEventListener('click', async () => {
        console.log('‚Üí signing out');
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      });

      try {
        // 1Ô∏è‚É£ Auth check
        console.log('‚Üí checking auth');
        const { data: { user }, error: authErr } = await supabase.auth.getUser();
        if (authErr) throw authErr;
        if (!user) {
          console.warn('√ó not logged in, redirecting');
          return window.location.href = 'index.html';
        }
        console.log('‚úî logged in as', user.email);

        // 2Ô∏è‚É£ Fetch rides
        console.log('‚Üí fetching rides');
        const { data: rides, error: fetchErr } = await supabase
          .from('ride_logs')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });
        if (fetchErr) throw fetchErr;

        rideList.innerHTML = '';
        if (!rides.length) {
          console.log('‚Äì no rides found');
          rideList.textContent = 'No rides logged yet.';
        } else {
          console.log(`‚úî rendering ${rides.length} rides`);
          rides.forEach(ride => {
            const item = document.createElement('div');
            item.className = 'ride-entry';
            item.innerHTML = `
              <div class="ride-title">${ride.title}</div>
              <div class="ride-details">
                <span>üìç ${ride.distance_km.toFixed(1)} km</span>
                <span>‚è± ${ride.duration_min} min</span>
                <span>‚õ∞Ô∏è ${ride.elevation_m} m</span>
              </div>
            `;

            // ‚Üê Your click handler is here!
        item.addEventListener('click', () => {
          console.log('‚Üí ride clicked:', ride.id);
          // send the user to index.html?ride=<id>
          window.location.href = `index.html?ride=${ride.id}`;
        });



            rideList.appendChild(item);
          });
        }
      } catch (err) {
        console.error('‚ùå dashboard error:', err);
        rideList.textContent = '‚ö†Ô∏è Error loading rides. Check console.';
      }

      // 3Ô∏è‚É£ Logout
      logoutBtn.addEventListener('click', async () => {
        console.log('‚Üí signing out');
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      });

      console.log('‚ö° dashboard module end');
    })();
  </script>
</body>
</html>
