<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memory Lanes Ride Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet Core CSS (must come before custom styles) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- Leaflet.Editable CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-editable@1.2.0/dist/Leaflet.Editable.css"/>
  <!-- Main App Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Favicon (optional, update the path as needed) -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet Core JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.Editable JS (must be after Leaflet) -->
  <script src="https://unpkg.com/leaflet-editable@1.2.0/dist/Leaflet.Editable.min.js"></script>
</head>

<body>
  <!-- ================= HEADER =================== -->
  <header>
    <h1 id="main-title">Memory Lanes Ride Journal</h1>
    <a class="coffee-btn" href="https://www.buymeacoffee.com/samarsharma" target="_blank" rel="noopener">☕ Buy Me a Coffee</a>
    <nav id="top-nav">
      <button id="back-dashboard-nav" style="display:none;">← Back to Dashboard</button>
      <button id="logout-btn" style="display:none;">Logout</button>
    </nav>
  </header>

  <!-- =========== UPLOAD SECTION =========== -->
  <main>
    <section id="upload-section" class="card upload-section">
      <form>
        <label for="gpx-upload"><b>Choose .GPX Ride File:</b></label>
        <input type="file" id="gpx-upload" accept=".gpx" required />
      </form>
      <div class="upload-actions">
        <button id="download-summary" class="btn" style="display:none;">
          <span>📁 Download Summary</span>
        </button>
        <button id="export-video" class="btn" style="display:none;">
          <span>📹 Export Video</span>
        </button>
      </div>
    </section>

    <!-- =========== FALLBACK ERROR (hidden unless error) =========== -->
    <section id="fallback-error" style="display:none;">
      <div class="error-message">
        <span id="fallback-error-message"></span>
      </div>
      <div class="error-actions">
        <button id="back-dashboard-nav" style="display:none;">← Back to Dashboard</button>
        <button id="logout-btn-fallback" style="display:none;">Logout</button>
      </div>
    </section>

    <!-- =========== SAVE RIDE FORM =========== -->
    <section id="save-ride-form" class="card save-ride-form" style="display:none;">
      <h3>Log this Ride</h3>
      <label for="ride-title">Ride Title:</label>
      <input type="text" id="ride-title" maxlength="64" autocomplete="off" />
      <button id="save-ride-btn" class="btn">Save Ride</button>
      <span id="save-status" class="status-msg"></span>
    </section>

    <!-- =========== AUTH SECTION =========== -->
    <section id="auth-section" class="card" style="display:none;">
      <h3>Login or Sign Up</h3>
      <input type="email" id="auth-email" placeholder="Email" autocomplete="username" />
      <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password" />
      <button id="login-btn" class="btn">Login</button>
      <button id="signup-btn" class="btn">Sign Up</button>
      <span id="auth-status" class="status-msg"></span>
    </section>

    <!-- =========== MAIN RIDE UI =========== -->
    <section id="main-ride-ui" style="display:none;">
      <!-- Ride title display & navigation -->
      <div id="ride-title-display" class="ride-title"></div>
      <nav id="ride-card-nav"></nav>

      <!-- Ride controls (upload another, back) -->
      <div id="ride-controls" style="display:none;">
        <button id="back-dashboard" class="btn">← Back to Dashboard</button>
        <button id="upload-another" class="btn">Upload Another</button>
      </div>

      <!-- Ride Actions (after loading a saved ride) -->
      <div id="ride-actions" style="display:none;">
        <!-- Reserved for any post-save actions -->
      </div>

      <!-- =========== Edit Controls =========== -->
      <div id="edit-controls" class="edit-controls" style="display:none;">
        <div id="editExperimentalBanner" style="display:none;margin-bottom:1em;"></div>
        <button id="edit-gpx-btn" class="btn-edit"><span>✏️ Edit Route</span></button>
        <button id="save-edited-gpx-btn" class="btn" style="display:none;">💾 Save As New Route</button>
        <button id="undo-edit-btn" class="btn" style="display:none;">Undo</button>
        <button id="redo-edit-btn" class="btn" style="display:none;">Redo</button>
        <button id="bulk-add-btn" class="btn" style="display:none;">Bulk Add</button>
        <button id="bulk-delete-btn" class="btn" style="display:none;">Bulk Delete</button>
        <button id="exit-edit-btn" class="btn" style="display:none;">Exit Edit</button>
        <span id="edit-mode-hint"></span>
        <div id="edit-help" class="edit-help" style="display:none;">
          <small>Use the tools above to bulk add/delete or move points.<br>Save your edits as a <b>new</b> route. <br>Experimental feature, in testing!</small>
        </div>
      </div>

      <!-- =========== Map & Analytics =========== -->
      <section class="map-analytics-section">
        <div id="leaflet-map" class="leaflet-map"></div>
        <!-- Telemetry quick-stats -->
        <div class="telemetry-summary">
          <span>📏 <b>Distance:</b> <span id="distance">–</span></span>
          <span>⏱️ <b>Total Duration:</b> <span id="duration">–</span></span>
          <span>🏁 <b>Ride Time:</b> <span id="ride-time">–</span></span>
          <span>⛰️ <b>Elevation Gain:</b> <span id="elevation">–</span></span>
        </div>
        <div class="replay-controls">
          <input type="range" id="replay-slider" value="0" min="0" max="100" step="1" disabled />
          <button id="play-replay" class="btn" disabled>▶️ Play</button>
          <label for="playback-speed">Speed:</label>
          <select id="playback-speed" disabled>
            <option value="1">1x</option>
            <option value="2">2x</option>
            <option value="4">4x</option>
          </select>
        </div>
        <div id="telemetry-details">
          <span>📈 <b>Elevation:</b> <span id="telemetry-elevation">–</span></span>
          <span>📏 <b>Distance:</b> <span id="telemetry-distance">–</span></span>
          <span>💨 <b>Speed:</b> <span id="telemetry-speed">–</span></span>
        </div>
      </section>

      <!-- =========== Analytics Toggle Button =========== -->
      <button id="show-analytics-btn" class="btn" style="display:none;">Show Ride Analytics ▼</button>

      <!-- =========== Analytics Container =========== -->
      <section id="analytics-container" style="display:none;">
        <h2>Ride Analytics</h2>
        <div class="analytics-charts">
          <div class="chart-block">
            <label>
              <input type="radio" name="chartMode" value="elevation" checked /> Elevation
            </label>
            <label>
              <input type="radio" name="chartMode" value="speed" /> Speed
            </label>
            <canvas id="elevationChart"></canvas>
          </div>
          <div class="chart-block">
            <canvas id="accelChart"></canvas>
          </div>
          <div class="chart-block">
            <canvas id="cornerChart"></canvas>
          </div>
        </div>
        <div id="speed-bins-section">
          <label for="speed-bins"><b>Highlight speed:</b></label>
          <div id="speed-bins"></div>
        </div>
      </section>
    </section>
  </main>
  
  <!-- ========== SCRIPTS (must be last!) ========== -->
  <script type="module" src="script.js"></script>
</body>
</html>
